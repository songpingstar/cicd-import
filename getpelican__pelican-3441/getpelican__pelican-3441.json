{
    "instance_id": "getpelican__pelican-3441",
    "patch": "diff --git a/docs/settings.rst b/docs/settings.rst\nindex 72c72fb1e..8e634d8f9 100644\n--- a/docs/settings.rst\n+++ b/docs/settings.rst\n@@ -150,13 +150,17 @@ Basic settings\n \n       READERS = {'foo': FooReader}\n \n-.. data:: IGNORE_FILES = ['.*']\n+.. data:: IGNORE_FILES = ['**/.*']\n \n-   A list of glob patterns. Files and directories matching any of these patterns\n-   will be ignored by the processor. For example, the default ``['.*']`` will\n+   A list of Unix glob patterns. Files and directories matching any of these patterns\n+   or any of the commonly hidden files and directories set by ``watchfiles.DefaultFilter``\n+   will be ignored by the processor. For example, the default ``['**/.*']`` will\n    ignore \"hidden\" files and directories, and ``['__pycache__']`` would ignore\n    Python 3's bytecode caches.\n \n+   For a full list of the commonly hidden files set by ``watchfiles.DefaultFilter``,\n+   please refer to the `watchfiles documentation`_.\n+\n .. data:: MARKDOWN = {...}\n \n    Extra configuration settings for the Markdown processor. Refer to the Python\n@@ -1423,3 +1427,4 @@ Example settings\n \n .. _Jinja Environment documentation: https://jinja.palletsprojects.com/en/latest/api/#jinja2.Environment\n .. _Docutils Configuration: http://docutils.sourceforge.net/docs/user/config.html\n+.. _`watchfiles documentation`: https://watchfiles.helpmanual.io/api/filters/#watchfiles.DefaultFilter.ignore_dirs\ndiff --git a/pelican/settings.py b/pelican/settings.py\nindex 1fb0b2111..3abe11bbe 100644\n--- a/pelican/settings.py\n+++ b/pelican/settings.py\n@@ -158,7 +158,7 @@ def load_source(name: str, path: str) -> ModuleType:\n     \"PYGMENTS_RST_OPTIONS\": {},\n     \"TEMPLATE_PAGES\": {},\n     \"TEMPLATE_EXTENSIONS\": [\".html\"],\n-    \"IGNORE_FILES\": [\".*\"],\n+    \"IGNORE_FILES\": [\"**/.*\"],\n     \"SLUG_REGEX_SUBSTITUTIONS\": [\n         (r\"[^\\w\\s-]\", \"\"),  # remove non-alphabetical/whitespace/'-' chars\n         (r\"(?u)\\A\\s*\", \"\"),  # strip leading whitespace\ndiff --git a/pelican/utils.py b/pelican/utils.py\nindex 21dbe804e..75889a7bb 100644\n--- a/pelican/utils.py\n+++ b/pelican/utils.py\n@@ -811,15 +811,30 @@ def order_content(\n     return content_list\n \n \n+class FileChangeFilter(watchfiles.DefaultFilter):\n+    def __init__(self, ignore_file_patterns: Sequence[str], *args, **kwargs):\n+        super().__init__(*args, **kwargs)\n+        self.ignore_file_patterns = ignore_file_patterns\n+\n+    def __call__(self, change: watchfiles.Change, path: str) -> bool:\n+        \"\"\"Returns `True` if a file should be watched for changes. The `IGNORE_FILES`\n+        setting is a list of Unix glob patterns. This call will filter out files and\n+        directories specified by `IGNORE_FILES` Pelican setting and by the default\n+        filters of `watchfiles.DefaultFilter`, seen here:\n+        https://watchfiles.helpmanual.io/api/filters/#watchfiles.DefaultFilter.ignore_dirs\n+        \"\"\"\n+        return super().__call__(change, path) and not any(\n+            fnmatch.fnmatch(os.path.abspath(path), p) for p in self.ignore_file_patterns\n+        )\n+\n+\n def wait_for_changes(\n     settings_file: str,\n     settings: Settings,\n ) -> set[tuple[Change, str]]:\n     content_path = settings.get(\"PATH\", \"\")\n     theme_path = settings.get(\"THEME\", \"\")\n-    ignore_files = {\n-        fnmatch.translate(pattern) for pattern in settings.get(\"IGNORE_FILES\", [])\n-    }\n+    ignore_file_patterns = set(settings.get(\"IGNORE_FILES\", []))\n \n     candidate_paths = [\n         settings_file,\n@@ -844,7 +859,7 @@ def wait_for_changes(\n     return next(\n         watchfiles.watch(\n             *watching_paths,\n-            watch_filter=watchfiles.DefaultFilter(ignore_entity_patterns=ignore_files),  # type: ignore\n+            watch_filter=FileChangeFilter(ignore_file_patterns=ignore_file_patterns),\n             rust_timeout=0,\n         )\n     )\n",
    "repo": "getpelican/pelican",
    "base_commit": "8a1c55ed07f9d749e7f45c1711f63fb93a51daa7",
    "hints_text": "I do not have access to any systems running Windows and thus cannot reproduce. I do not see much in the [diff between 4.10.1 and 4.10.2](https://github.com/getpelican/pelican/compare/4.10.1...4.10.2#files_bucket) that would cause the described problem, but of course I cannot rule it out.\r\n\r\n@MinchinWeb: Could you run a few quick tests and see if you can confirm the problem described here?\nSure thing! \n\n@mauricef , would you be able to run `pip freeze` and paste the contents (or a screenshot) as a comment here?\n\nThe drive you're watching, is it a local (i.e. attached to your computer) or network drive?\n\nLastly, to confirm, you're remembering to save your (post) file after you change it? (I've been bitten by this an embarrassingly high number of times...) \nIt looks like it's [this change](\r\nhttps://github.com/getpelican/pelican/compare/4.10.1...4.10.2#diff-c8a05c81de04a8fad4f855ba8be2ed465cd5b7700a84f4fb46582545ad223facL160)\r\n\r\nIf I override IGNORE_FILES in pelicanconf.py and set it back to \r\n\r\n`IGNORE_FILES\": [\".#*\"]`\r\n\r\nThen the changes are detected\nGood to know. Do you have any idea _why_ this change has that effect? In theory, it should only ignore invisible files and folders. \nI'm not sure, I'll play around with it some more, I see it gets translated to via fnmatch.translate and passed to watchfiles as a filter, I'll see if I can isolate the issue outside pelican.\r\n\r\n@MinchinWeb It's a local drive, I have confirmed I'm saving the file and here is pip freeze\r\n\r\n```\r\nanyio==4.6.2.post1\r\nblinker==1.9.0\r\ndocutils==0.21.2\r\nfeedgenerator==2.1.0\r\nidna==3.10\r\nJinja2==3.1.4\r\nMarkdown==3.7\r\nmarkdown-it-py==3.0.0\r\nMarkupSafe==3.0.2\r\nmdurl==0.1.2\r\nordered-set==4.1.0\r\npelican==4.10.2\r\nPygments==2.18.0\r\npython-dateutil==2.9.0.post0\r\npytz==2024.2\r\nrich==13.9.4\r\nsix==1.16.0\r\nsniffio==1.3.1\r\ntzdata==2024.2\r\nUnidecode==1.3.8\r\nwatchfiles==1.0.0\r\n```\n@mauricef Thanks! I'll need some more time to dig into it, but I'll post back here\n@MinchinWeb running into the same issues on Ubuntu 22.04 with Pelican 4.10.2. The issue - I think - lies in https://github.com/getpelican/pelican/commit/1edca552532ae3f3dc72ee4a2bd8109d2b293fdc. It's the only meaningful commit between the two patch versions that could be the cause of the issue.\n@MinchinWeb I have the same problem on macOS 15.2 with Python 3.11.7 and Pelican 4.10.2. Reverting to 4.10.1 solves the problem.\n@projectgus: Any idea why your change in #3424 would cause the problem mentioned in this issue?\nAh, snap. Sorry! I have not verified, but I think this might happen when the settings `PATH` value has its default of `os.curdir`, which is often `\".\"` .\r\n\r\nSo the watcher is coming back with paths like `./some_file.md` and this is matching the ignore pattern `.*` as the unix-style globs also match directory separators. :facepalm: \r\n\r\nI guess the quick fix is to revert that commit, sorry I didn't see this coming (my Pelican config has `PATH` set to  a directory name).\r\n\r\nAlthough, it seems like the ignore patterns are being applied differently in the initial content search versus the auto-reload file watch, if the initial content search is working as expected. So the \"best fix\" long term is probably to make the file watch behaviour consistent to that. If this is still open in a week or two then I'll have a little time and would be happy to take a proper look at that, then.\nMy `PATH` is set to 'content' and I still encounter this error; using the old value for `IGNORE_FILES` works for me. \n\nI could take a look at this issue - maybe a small commit first to undo the ignore files setting change and then I can look into making the initial file search consistent with the autoreload file search\n@projectgus: Thank you for the thoughtful comment! Looking forward to having you involved in the resolution.\r\n\r\n@yashaslokesh: Many thanks for offering to take a closer look at this issue ‚Äî that would be great. I would like to publish a release containing a fix in early January, so your assistance would be much appreciated! üòä ",
    "created_at": "2025-01-02T06:10:23Z",
    "test_patch": "diff --git a/pelican/tests/test_utils.py b/pelican/tests/test_utils.py\nindex c35b756c5..01ad1c583 100644\n--- a/pelican/tests/test_utils.py\n+++ b/pelican/tests/test_utils.py\n@@ -6,6 +6,8 @@\n from sys import platform\n from tempfile import mkdtemp\n \n+import watchfiles\n+\n try:\n     from zoneinfo import ZoneInfo\n except ModuleNotFoundError:\n@@ -13,7 +15,7 @@\n \n from pelican import utils\n from pelican.generators import TemplatePagesGenerator\n-from pelican.settings import read_settings\n+from pelican.settings import DEFAULT_CONFIG, read_settings\n from pelican.tests.support import (\n     LoggedTestCase,\n     get_article,\n@@ -990,3 +992,68 @@ def test_file_suffix(self):\n         self.assertEqual(\"\", utils.file_suffix(\"\"))\n         self.assertEqual(\"\", utils.file_suffix(\"foo\"))\n         self.assertEqual(\"md\", utils.file_suffix(\"foo.md\"))\n+\n+\n+class TestFileChangeFilter(unittest.TestCase):\n+    ignore_file_patterns = DEFAULT_CONFIG[\"IGNORE_FILES\"]\n+\n+    def test_regular_files_not_filtered(self):\n+        filter = utils.FileChangeFilter(ignore_file_patterns=self.ignore_file_patterns)\n+        basename = \"article.rst\"\n+        full_path = os.path.join(os.path.dirname(__file__), \"content\", basename)\n+\n+        for change in watchfiles.Change:\n+            self.assertTrue(filter(change=change, path=basename))\n+            self.assertTrue(filter(change=change, path=full_path))\n+\n+    def test_dotfiles_filtered(self):\n+        filter = utils.FileChangeFilter(ignore_file_patterns=self.ignore_file_patterns)\n+        basename = \".config\"\n+        full_path = os.path.join(os.path.dirname(__file__), \"content\", basename)\n+\n+        # Testing with just the hidden file name and the full file path to the hidden file\n+        for change in watchfiles.Change:\n+            self.assertFalse(filter(change=change, path=basename))\n+            self.assertFalse(filter(change=change, path=full_path))\n+\n+    def test_default_filters(self):\n+        # Testing a subset of the default filters\n+        # For reference: https://watchfiles.helpmanual.io/api/filters/#watchfiles.DefaultFilter.ignore_dirs\n+        filter = utils.FileChangeFilter(ignore_file_patterns=[])\n+        test_basenames = [\n+            \"__pycache__\",\n+            \".git\",\n+            \".hg\",\n+            \".svn\",\n+            \".tox\",\n+            \".venv\",\n+            \".idea\",\n+            \"node_modules\",\n+            \".mypy_cache\",\n+            \".pytest_cache\",\n+            \".hypothesis\",\n+            \".DS_Store\",\n+            \"flycheck_file\",\n+            \"test_file~\",\n+        ]\n+\n+        for basename in test_basenames:\n+            full_path = os.path.join(os.path.dirname(__file__), basename)\n+            for change in watchfiles.Change:\n+                self.assertFalse(filter(change=change, path=basename))\n+                self.assertFalse(filter(change=change, path=full_path))\n+\n+    def test_custom_ignore_pattern(self):\n+        filter = utils.FileChangeFilter(ignore_file_patterns=[\"*.rst\"])\n+        basename = \"article.rst\"\n+        full_path = os.path.join(os.path.dirname(__file__), basename)\n+        for change in watchfiles.Change:\n+            self.assertFalse(filter(change=change, path=basename))\n+            self.assertFalse(filter(change=change, path=full_path))\n+\n+        # If the user changes `IGNORE_FILES` to only contain ['*.rst'], then dotfiles would not be filtered anymore\n+        basename = \".config\"\n+        full_path = os.path.join(os.path.dirname(__file__), basename)\n+        for change in watchfiles.Change:\n+            self.assertTrue(filter(change=change, path=basename))\n+            self.assertTrue(filter(change=change, path=full_path))\n",
    "problem_statement": "pelican -lr not reloading on content changes in 4.10.2 on Windows 11\n<!--\r\n  Hi there! Thank you for discovering and submitting an issue.\r\n\r\n  Before you submit this, let‚Äôs make sure of a few things.\r\n  Please make sure the following boxes are ticked if they are correct.\r\n  If not, please try and fulfill them first.\r\n-->\r\n\r\n<!-- Checked checkbox should look like this: [x] -->\r\n- [ x] I have read the [Filing Issues](https://docs.getpelican.com/en/latest/contribute.html#filing-issues) and subsequent ‚ÄúHow to Get Help‚Äù sections of the documentation.\r\n- [ x] I can reproduce this problem with stock/default settings file, theme, and sample content (as described in above ‚ÄúHow to Get Help‚Äù sections of the documentation).\r\n- [ x] I have searched the [issues](https://github.com/getpelican/pelican/issues?q=is%3Aissue) (including closed ones) and believe that this is not a duplicate.\r\n\r\n\r\n- **OS version and name**:  Windows 11 HOME\r\n- **Python version**: Python 3.12.4\r\n- **Pelican version**: 4.10.2\r\n- **Link to theme**: default\r\n- **Links to plugins**: default\r\n\r\n## Issue\r\nI installed pelican 4.10.2[markdown] and ran the quickstart command and added a single article from the [guide](https://docs.getpelican.com/en/3.6.2/quickstart.html).\r\n\r\nI run pelican -lr and editing the article does not cause an autoreload. If I downgrade to pelican 4.10.1, autoreload works as expected.\n",
    "environment_setup_commit": "8a1c55ed07f9d749e7f45c1711f63fb93a51daa7",
    "pr_url": "https://github.com/getpelican/pelican/pull/3441",
    "issue_url": "https://github.com/getpelican/pelican/issues/3431",
    "issue_numbers": [
        "3431"
    ]
}