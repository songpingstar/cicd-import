{
    "instance_id": "getpelican__pelican-1926",
    "patch": "diff --git a/docs/changelog.rst b/docs/changelog.rst\nindex f52d64493..6a4d65a4e 100644\n--- a/docs/changelog.rst\n+++ b/docs/changelog.rst\n@@ -4,7 +4,17 @@ Release history\n Next release\n ============\n \n-- Nothing yet\n+* ``SLUG_SUBSTITUTIONS`` now accepts 3-tuple elements, allowing to keep\n+  non-alphanum characters. Existing 2-tuple configurations will continue to work\n+  without change in behavior. The new 3rd parameter has side effects when there\n+  are multiple substitutions defined. Plese see the docs.\n+* Tag and category slugs can be controlled with greater precision using the\n+  ``TAG_SUBSTITUTIONS`` and ``CATEGORY_SUBSTITUTIONS`` settings. These also\n+  allow for keeping non-alphanum characters for backward compatibility with\n+  existing URLs.\n+* Author slugs can be controlled with greater precision using the\n+  ``AUTHOR_SUBSTITUTIONS`` setting. Keeping non-alphanum characters is supported\n+  as well but discouraged.\n \n 3.6.3 (2015-08-14)\n ==================\ndiff --git a/docs/settings.rst b/docs/settings.rst\nindex 0adda9925..1de28c124 100644\n--- a/docs/settings.rst\n+++ b/docs/settings.rst\n@@ -306,8 +306,14 @@ Setting name (followed by default value, if any)        What does it do?\n ``DAY_ARCHIVE_SAVE_AS = ''``                            The location to save per-day archives of your posts.\n ``SLUG_SUBSTITUTIONS = ()``                             Substitutions to make prior to stripping out\n                                                         non-alphanumerics when generating slugs. Specified\n-                                                        as a list of 2-tuples of ``(from, to)`` which are\n-                                                        applied in order.\n+                                                        as a list of 3-tuples of ``(from, to, skip)`` which are\n+                                                        applied in order. ``skip`` is a boolean indicating whether\n+                                                        or not to skip replacement of non-alphanumeric characters.\n+                                                        Useful for backward compatibility with existing URLs.\n+``AUTHOR_SUBSTITUTIONS = ()``                           Substitutions for authors. ``SLUG_SUBSTITUTIONS`` is not\n+                                                        taken into account here!\n+``CATEGORY_SUBSTITUTIONS = ()``                         Added to ``SLUG_SUBSTITUTIONS`` for categories.\n+``TAG_SUBSTITUTIONS = ()``                              Added to ``SLUG_SUBSTITUTIONS`` for tags.\n ======================================================  ==============================================================\n \n .. note::\n@@ -317,6 +323,20 @@ Setting name (followed by default value, if any)        What does it do?\n     set the corresponding ``*_SAVE_AS`` setting to ``''`` to prevent the\n     relevant page from being generated.\n \n+.. note::\n+\n+    Substitutions are applied in order with the side effect that keeping\n+    non-alphanum characters applies to the whole string when a replacement\n+    is made. For example if you have the following setting\n+    ``SLUG_SUBSTITUTIONS = (('C++', 'cpp'), ('keep dot', 'keep.dot', True))``\n+    the string ``Keep Dot`` will be converted to ``keep.dot``, however\n+    ``C++ will keep dot`` will be converted to ``cpp will keep.dot`` instead\n+    of ``cpp-will-keep.dot``!\n+    \n+    If you want to keep non-alphanum characters only for tags or categories\n+    but not other slugs then configure ``TAG_SUBSTITUTIONS`` and\n+    ``CATEGORY_SUBSTITUTIONS`` respectively!\n+\n Pelican can optionally create per-year, per-month, and per-day archives of your\n posts. These secondary archives are disabled by default but are automatically\n enabled if you supply format strings for their respective ``_SAVE_AS`` settings.\ndiff --git a/pelican/contents.py b/pelican/contents.py\nindex 0123384ac..9b6aa971d 100644\n--- a/pelican/contents.py\n+++ b/pelican/contents.py\n@@ -172,6 +172,7 @@ def url_format(self):\n             'lang': getattr(self, 'lang', 'en'),\n             'date': getattr(self, 'date', SafeDatetime.now()),\n             'author': self.author.slug if hasattr(self, 'author') else '',\n+            'tag': self.tag.slug if hasattr(self, 'tag') else '',\n             'category': self.category.slug if hasattr(self, 'category') else ''\n         })\n         return metadata\ndiff --git a/pelican/urlwrappers.py b/pelican/urlwrappers.py\nindex bf1199a8a..7659471d2 100644\n--- a/pelican/urlwrappers.py\n+++ b/pelican/urlwrappers.py\n@@ -112,13 +112,33 @@ def _from_settings(self, key, get_page_name=False):\n \n \n class Category(URLWrapper):\n-    pass\n+    @property\n+    def slug(self):\n+        if self._slug is None:\n+            substitutions = self.settings.get('SLUG_SUBSTITUTIONS', ())\n+            substitutions += tuple(self.settings.get('CATEGORY_SUBSTITUTIONS',\n+                                                     ()))\n+            self._slug = slugify(self.name, substitutions)\n+        return self._slug\n \n \n class Tag(URLWrapper):\n     def __init__(self, name, *args, **kwargs):\n         super(Tag, self).__init__(name.strip(), *args, **kwargs)\n \n+    @property\n+    def slug(self):\n+        if self._slug is None:\n+            substitutions = self.settings.get('SLUG_SUBSTITUTIONS', ())\n+            substitutions += tuple(self.settings.get('TAG_SUBSTITUTIONS', ()))\n+            self._slug = slugify(self.name, substitutions)\n+        return self._slug\n+\n \n class Author(URLWrapper):\n-    pass\n+    @property\n+    def slug(self):\n+        if self._slug is None:\n+            self._slug = slugify(self.name,\n+                                 self.settings.get('AUTHOR_SUBSTITUTIONS', ()))\n+        return self._slug\ndiff --git a/pelican/utils.py b/pelican/utils.py\nindex b5685a3b5..4e7293611 100644\n--- a/pelican/utils.py\n+++ b/pelican/utils.py\n@@ -270,10 +270,34 @@ def slugify(value, substitutions=()):\n         value = value.decode('ascii')\n     # still unicode\n     value = unicodedata.normalize('NFKD', value).lower()\n-    for src, dst in substitutions:\n+\n+    # backward compatible covert from 2-tuples to 3-tuples\n+    new_subs = []\n+    for tpl in substitutions:\n+        try:\n+            src, dst, skip = tpl\n+        except ValueError:\n+            src, dst = tpl\n+            skip = False\n+        new_subs.append((src, dst, skip))\n+    substitutions = tuple(new_subs)\n+\n+    # by default will replace non-alphanum characters\n+    replace = True\n+    for src, dst, skip in substitutions:\n+        orig_value = value\n         value = value.replace(src.lower(), dst.lower())\n-    value = re.sub('[^\\w\\s-]', '', value).strip()\n-    value = re.sub('[-\\s]+', '-', value)\n+        # if replacement was made then skip non-alphanum\n+        # replacement if instructed to do so\n+        if value != orig_value:\n+            replace = replace and not skip\n+\n+    if replace:\n+        value = re.sub('[^\\w\\s-]', '', value).strip()\n+        value = re.sub('[-\\s]+', '-', value)\n+    else:\n+        value = value.strip()\n+\n     # we want only ASCII chars\n     value = value.encode('ascii', 'ignore')\n     # but Pelican should generally use only unicode\n",
    "repo": "getpelican/pelican",
    "base_commit": "70665ea0fa659c01b8dd0124b0ea82696d2bf91d",
    "hints_text": "",
    "created_at": "2016-03-13T22:19:35Z",
    "test_patch": "diff --git a/pelican/tests/test_contents.py b/pelican/tests/test_contents.py\nindex 6f0f6dd93..2f774a6e0 100644\n--- a/pelican/tests/test_contents.py\n+++ b/pelican/tests/test_contents.py\n@@ -11,7 +11,7 @@\n \n import six\n \n-from pelican.contents import Article, Author, Category, Page, Static\n+from pelican.contents import Article, Author, Category, Page, Static, Tag\n from pelican.settings import DEFAULT_CONFIG\n from pelican.signals import content_object_init\n from pelican.tests.support import LoggedTestCase, get_settings, unittest\n@@ -457,6 +457,46 @@ def test_slugify_category_author(self):\n         self.assertEqual(\n             article.save_as, 'obrien/csharp-stuff/fnord/index.html')\n \n+    def test_slugify_with_author_substitutions(self):\n+        settings = get_settings()\n+        settings['AUTHOR_SUBSTITUTIONS'] = [\n+                                    ('Alexander Todorov', 'atodorov', False),\n+                                    ('Krasimir Tsonev', 'krasimir', False),\n+        ]\n+        settings['ARTICLE_URL'] = 'blog/{author}/{slug}/'\n+        settings['ARTICLE_SAVE_AS'] = 'blog/{author}/{slug}/index.html'\n+        article_kwargs = self._copy_page_kwargs()\n+        article_kwargs['metadata']['author'] = Author('Alexander Todorov',\n+                                                      settings)\n+        article_kwargs['metadata']['title'] = 'fnord'\n+        article_kwargs['settings'] = settings\n+        article = Article(**article_kwargs)\n+        self.assertEqual(article.url, 'blog/atodorov/fnord/')\n+        self.assertEqual(article.save_as, 'blog/atodorov/fnord/index.html')\n+\n+    def test_slugify_category_with_dots(self):\n+        settings = get_settings()\n+        settings['CATEGORY_SUBSTITUTIONS'] = [('Fedora QA', 'fedora.qa', True)]\n+        settings['ARTICLE_URL'] = '{category}/{slug}/'\n+        article_kwargs = self._copy_page_kwargs()\n+        article_kwargs['metadata']['category'] = Category('Fedora QA',\n+                                                          settings)\n+        article_kwargs['metadata']['title'] = 'This Week in Fedora QA'\n+        article_kwargs['settings'] = settings\n+        article = Article(**article_kwargs)\n+        self.assertEqual(article.url, 'fedora.qa/this-week-in-fedora-qa/')\n+\n+    def test_slugify_tags_with_dots(self):\n+        settings = get_settings()\n+        settings['TAG_SUBSTITUTIONS'] = [('Fedora QA', 'fedora.qa', True)]\n+        settings['ARTICLE_URL'] = '{tag}/{slug}/'\n+        article_kwargs = self._copy_page_kwargs()\n+        article_kwargs['metadata']['tag'] = Tag('Fedora QA', settings)\n+        article_kwargs['metadata']['title'] = 'This Week in Fedora QA'\n+        article_kwargs['settings'] = settings\n+        article = Article(**article_kwargs)\n+        self.assertEqual(article.url, 'fedora.qa/this-week-in-fedora-qa/')\n+\n \n class TestStatic(LoggedTestCase):\n \ndiff --git a/pelican/tests/test_urlwrappers.py b/pelican/tests/test_urlwrappers.py\nindex f3dc81989..21a7d98f5 100644\n--- a/pelican/tests/test_urlwrappers.py\n+++ b/pelican/tests/test_urlwrappers.py\n@@ -56,3 +56,34 @@ def test_equality(self):\n \n         cat_ascii = Category('指導書', settings={})\n         self.assertEqual(cat_ascii, u'zhi-dao-shu')\n+\n+    def test_slugify_with_substitutions_and_dots(self):\n+        tag = Tag('Tag Dot',\n+                  settings={\n+                        'TAG_SUBSTITUTIONS': [('Tag Dot', 'tag.dot', True)]\n+                    })\n+        cat = Category('Category Dot',\n+                       settings={\n+                        'CATEGORY_SUBSTITUTIONS': (('Category Dot',\n+                                                    'cat.dot',\n+                                                    True),)\n+                        })\n+\n+        self.assertEqual(tag.slug, 'tag.dot')\n+        self.assertEqual(cat.slug, 'cat.dot')\n+\n+    def test_author_slug_substitutions(self):\n+        settings = {\n+            'AUTHOR_SUBSTITUTIONS': [\n+                                    ('Alexander Todorov', 'atodorov', False),\n+                                    ('Krasimir Tsonev', 'krasimir', False),\n+            ]\n+        }\n+\n+        author1 = Author('Mr. Senko', settings=settings)\n+        author2 = Author('Alexander Todorov', settings=settings)\n+        author3 = Author('Krasimir Tsonev', settings=settings)\n+\n+        self.assertEqual(author1.slug, 'mr-senko')\n+        self.assertEqual(author2.slug, 'atodorov')\n+        self.assertEqual(author3.slug, 'krasimir')\ndiff --git a/pelican/tests/test_utils.py b/pelican/tests/test_utils.py\nindex fed7e94b4..8dfc0b9bc 100644\n--- a/pelican/tests/test_utils.py\n+++ b/pelican/tests/test_utils.py\n@@ -131,6 +131,18 @@ def test_slugify_substitute(self):\n         for value, expected in samples:\n             self.assertEqual(utils.slugify(value, subs), expected)\n \n+    def test_slugify_substitute_and_keeping_non_alphanum(self):\n+\n+        samples = (('Fedora QA', 'fedora.qa'),\n+                   ('C++ is used by Fedora QA', 'cpp is used by fedora.qa'),\n+                   ('C++ is based on C', 'cpp-is-based-on-c'),\n+                   ('C+++ test C+ test', 'cpp-test-c-test'),)\n+\n+        subs = (('Fedora QA', 'fedora.qa', True),\n+                ('c++', 'cpp'),)\n+        for value, expected in samples:\n+            self.assertEqual(utils.slugify(value, subs), expected)\n+\n     def test_get_relative_path(self):\n \n         samples = ((os.path.join('test', 'test.html'), os.pardir),\n",
    "problem_statement": "RFE: Add slugs for tags for backward compatibility with existing URLs\nHi guys,\nI've migrated to Pelican from Octropress and managed to keep all articles URLs the same but had troubles with some tags. If your tag contains a dot (e.g. fedora.planet) then its sluge removes the dot (becomes fedoraplanet) and I don't see any way to keep my existing tag URL. \n\n",
    "environment_setup_commit": "70665ea0fa659c01b8dd0124b0ea82696d2bf91d",
    "pr_url": "https://github.com/getpelican/pelican/pull/1926",
    "issue_url": "https://github.com/getpelican/pelican/issues/1873",
    "issue_numbers": [
        "1873"
    ]
}