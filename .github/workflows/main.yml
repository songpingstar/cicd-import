name: pytest verification

on:
  push:
    branches: [main]

env:
  REPO_URL: https://github.com/getpelican/pelican.git
  INSTANCE_DIR: getpelican__pelican-2818
  REPO_DIR: pelican
  base_commit: e4d9c41a77b45cb7ff6b8d1732623990adf65931
  PY_URL: https://repo.anaconda.com/miniconda/Miniconda3-4.5.1-Linux-x86_64.sh
  #PY_URL: https://repo.anaconda.com/miniconda/Miniconda3-py39_23.1.0-1-Linux-x86_64.sh
  #PY_URL: https://repo.anaconda.com/miniconda/Miniconda3-py311_25.9.1-3-Linux-x86_64.sh
  TEST_FILE: pelican/tests/test_plugins.py
  CONDA_DIR: /opt/miniconda3
  RUN_PYTEST: 'false'

jobs:
  pytest-verification:
    name: pytest-verification
    runs-on: ubuntu-22.04
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
      
    - name: write setup_env
      run: |
        echo "开始写入setup_env 文件====================="
        cat > setup_env.sh << EOF
        #!/bin/bash
        cd /testbed/$REPO_DIR
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate base
        apt-get update -qq
        pip install -q --upgrade pip setuptools
        python -m pip install -U pip tox
        pip install -e .
        pip install -q -r requirements/test.pip
        #pip install -q -r test-requirements.txt
        #pip install -q --upgrade pytest
        pip install -v pytest==6.2.5
        EOF

    - name: Execute pytest steps
      uses: ./.github/actions/pytest
            
  call-docker-verification:
    needs: pytest-verification
    uses: ./.github/workflows/docker-verification.yml
    with:                       
      instance-dir: ${{ env.INSTANCE_DIR }}