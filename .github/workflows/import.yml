name: Tencent Kubernetes Engine

on:
  push:
    branches: [main]

env:
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp
  DEPLOYMENT_NAME: tke-test
  CONDA_DIR: /opt/miniconda3

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-22.04
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y --no-install-recommends \
        bzip2 \
        wget \
        git \
        ca-certificates \
        curl \
        && sudo apt-get clean \
        && sudo rm -rf /var/lib/apt/lists/*

    - name: Install Miniconda
      run: |
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
        bash miniconda.sh -b -p $CONDA_DIR
        rm miniconda.sh
        echo "$CONDA_DIR/bin" >> $GITHUB_PATH

    - name: Configure Conda
      run: |
        conda config --add channels conda-forge
        conda init bash

    - name: Setup repository
      run: |
        chmod +x Parsl__parsl-1175/setup_repo.sh
        ./Parsl__parsl-1175/setup_repo.sh

    - name: Setup environment
      run: |
        chmod +x Parsl__parsl-1175/setup_env.sh
        source $CONDA_DIR/bin/activate
        ./Parsl__parsl-1175/setup_env.sh
        conda activate testbed

    # 添加部署步骤...
