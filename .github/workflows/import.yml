name: pytest verification

on:
  push:
    branches: [main]

env:
  REPO_URL: https://github.com/PyGithub/PyGithub.git
  INSTANCE_DIR: PyGithub__PyGithub-2882
  REPO_DIR: PyGithub
  base_commit: 14af705195df8bf6557fae6fdd3afd198b92ba82
#  PY_URL: https://repo.anaconda.com/miniconda/Miniconda3-4.5.1-Linux-x86_64.sh
  PY_URL: https://repo.anaconda.com/miniconda/Miniconda3-py39_23.1.0-1-Linux-x86_64.sh
  CONDA_DIR: /opt/miniconda3

jobs:
  setup-build:
    name: Setup, Build
    runs-on: ubuntu-22.04
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y --no-install-recommends \
        wget \
        git \
        ca-certificates \
        curl \
        vim \
        dos2unix \
        # python3 \
        # python3-pip \
        # python-is-python3 

    - name: Install Miniconda
      run: |
        wget -q $PY_URL -O miniconda.sh
        bash miniconda.sh -b -p $CONDA_DIR
        rm miniconda.sh
        PATH=/opt/miniconda3/bin:${PATH}
        echo "/opt/miniconda3/bin" >> $GITHUB_PATH
        source ~/.bashrc
        conda config --add channels conda-forge
        echo "python版本是："
        python --version

    - name: setup_repo
      run: |
        echo "开始写入setup_repo.sh 文件====================="
        cat > setup_repo.sh << EOF
            #!/bin/bash
            #mkdir -p /testbed
            git clone $REPO_URL $INSTANCE_DIR/$REPO_DIR
            cd $INSTANCE_DIR/$REPO_DIR
            git checkout "$base_commit"
            #cd ..
        EOF
        echo "开始执行setup_repo.sh 脚本"
        bash setup_repo.sh


    - name: setup_env
      run: |
        echo "python版本是："
        python --version
        cd $INSTANCE_DIR/$REPO_DIR
        echo "开始写入setup_env 文件====================="
        cat > setup_env.sh << EOF
            #!/bin/bash
            pip install -q --upgrade pip setuptools
            pip install -e .
            pip install -q -r requirements/test.txt
            pip install -q --upgrade pytest
            #cd /testbed/$REPO_DIR
        EOF
        echo "开始执行setup_env 脚本====================="
        bash setup_env.sh
    - name: run verification test
      run: |
        echo "python版本是："
        python --version
        echo "pytest版本是："
        pytest --version

        cd $INSTANCE_DIR/$REPO_DIR
        pytest tests/Repository.py
        git apply ../test.patch 
        pytest tests/Repository.py || true
        git apply ../code.patch 
        pytest tests/Repository.py
        
    - name: run verification
      continue-on-error: true
      run: |
        echo "python版本是："
        python --version
        
        cd $INSTANCE_DIR
        python run_verification.py 
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
            ${{ env.INSTANCE_DIR }}/results.json
            ${{ env.INSTANCE_DIR }}/Dockerfile
            ${{ env.INSTANCE_DIR }}/${{ env.REPO_DIR }}/setup_env.sh
            setup_repo.sh
            ${{ env.INSTANCE_DIR }}/run_verification.py
            ${{ env.INSTANCE_DIR }}/${{ env.INSTANCE_DIR }}.json
