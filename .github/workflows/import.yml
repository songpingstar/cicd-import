name: Tencent Kubernetes Engine

on:
  push:
    branches: [main]

env:
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp
  DEPLOYMENT_NAME: tke-test
  CONDA_DIR: /opt/miniconda3

jobs:
  setup-build:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-22.04
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y --no-install-recommends \
        bzip2 \
        wget \
        git \
        ca-certificates \
        curl \
        && sudo apt-get clean \
        && sudo rm -rf /var/lib/apt/lists/*

    - name: Install Miniconda
      run: |
        wget https://repo.anaconda.com/miniconda/Miniconda3-4.5.1-Linux-x86_64.sh -O miniconda.sh
        bash miniconda.sh -b -p $CONDA_DIR
        rm miniconda.sh
        echo "$CONDA_DIR/bin" >> $GITHUB_PATH

   # - name: Configure Conda
   #   run: |
   #     conda init bash
   #     conda config --add channels conda-forge
   #     conda config --remove channels defaults
   #    mkdir 20251209

    - name: Setup repository
      run: |
        git clone https://github.com/Parsl/parsl.git Parsl__parsl-1175/parsl
        cd Parsl__parsl-1175/parsl
        git checkout "fe6d47e0774935e82e14f4cb8123c795f24c627f"
        

    - name: Setup environment
      run: |
        pip install --upgrade pip setuptools
        pip install numpy Cython
        pwd
        ls
        cd Parsl__parsl-1175/parsl
        pip install -r test-requirements.txt    
        
        
    - name: run py
      continue-on-error: true
      run: |
        cd Parsl__parsl-1175
        python -u run_verification.py 2>&1 | tee -a verification.log
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
            Parsl__parsl-1175/results.json
            Parsl__parsl-1175/verification.log
