{
    "instance_id": "PyCQA__bandit-1018",
    "patch": "diff --git a/bandit/plugins/hashlib_insecure_functions.py b/bandit/plugins/hashlib_insecure_functions.py\nindex 15603e9b1..710800a72 100644\n--- a/bandit/plugins/hashlib_insecure_functions.py\n+++ b/bandit/plugins/hashlib_insecure_functions.py\n@@ -6,7 +6,7 @@\n ======================================================================\n \n This plugin checks for the usage of the insecure MD4, MD5, or SHA1 hash\n-functions in ``hashlib``. The ``hashlib.new`` function provides\n+functions in ``hashlib`` and ``crypt``. The ``hashlib.new`` function provides\n the ability to construct a new hashing object using the named algorithm. This\n can be used to create insecure hash functions like MD4 and MD5 if they are\n passed as algorithm names to this function.\n@@ -17,6 +17,10 @@\n does additional checking for usage of keyword usedforsecurity on all\n function variations of hashlib.\n \n+Similar to ``hashlib``, this plugin also checks for usage of one of the\n+``crypt`` module's weak hashes. ``crypt`` also permits MD5 among other weak\n+hash variants.\n+\n :Example:\n \n .. code-block:: none\n@@ -40,6 +44,9 @@\n .. versionchanged:: 1.7.3\n     CWE information added\n \n+.. versionchanged:: 1.7.6\n+    Added check for the crypt module weak hashes\n+\n \"\"\"  # noqa: E501\n import sys\n \n@@ -48,64 +55,90 @@\n from bandit.core import test_properties as test\n \n WEAK_HASHES = (\"md4\", \"md5\", \"sha\", \"sha1\")\n-\n-\n-def _hashlib_func(context):\n-    if isinstance(context.call_function_name_qual, str):\n-        qualname_list = context.call_function_name_qual.split(\".\")\n-\n-        if \"hashlib\" in qualname_list:\n-            func = qualname_list[-1]\n-            keywords = context.call_keywords\n-\n-            if func in WEAK_HASHES:\n-                if keywords.get(\"usedforsecurity\", \"True\") == \"True\":\n-                    return bandit.Issue(\n-                        severity=bandit.HIGH,\n-                        confidence=bandit.HIGH,\n-                        cwe=issue.Cwe.BROKEN_CRYPTO,\n-                        text=f\"Use of weak {func.upper()} hash for security. \"\n-                        \"Consider usedforsecurity=False\",\n-                        lineno=context.node.lineno,\n-                    )\n-            elif func == \"new\":\n-                args = context.call_args\n-                name = args[0] if args else keywords.get(\"name\", None)\n-                if isinstance(name, str) and name.lower() in WEAK_HASHES:\n-                    if keywords.get(\"usedforsecurity\", \"True\") == \"True\":\n-                        return bandit.Issue(\n-                            severity=bandit.HIGH,\n-                            confidence=bandit.HIGH,\n-                            cwe=issue.Cwe.BROKEN_CRYPTO,\n-                            text=f\"Use of weak {name.upper()} hash for \"\n-                            \"security. Consider usedforsecurity=False\",\n-                            lineno=context.node.lineno,\n-                        )\n-\n-\n-def _hashlib_new(context):\n-    if isinstance(context.call_function_name_qual, str):\n-        qualname_list = context.call_function_name_qual.split(\".\")\n-        func = qualname_list[-1]\n-\n-        if \"hashlib\" in qualname_list and func == \"new\":\n-            args = context.call_args\n-            keywords = context.call_keywords\n-            name = args[0] if args else keywords.get(\"name\", None)\n-            if isinstance(name, str) and name.lower() in WEAK_HASHES:\n+WEAK_CRYPT_HASHES = (\"METHOD_CRYPT\", \"METHOD_MD5\", \"METHOD_BLOWFISH\")\n+\n+\n+def _hashlib_func(context, func):\n+    keywords = context.call_keywords\n+\n+    if func in WEAK_HASHES:\n+        if keywords.get(\"usedforsecurity\", \"True\") == \"True\":\n+            return bandit.Issue(\n+                severity=bandit.HIGH,\n+                confidence=bandit.HIGH,\n+                cwe=issue.Cwe.BROKEN_CRYPTO,\n+                text=f\"Use of weak {func.upper()} hash for security. \"\n+                \"Consider usedforsecurity=False\",\n+                lineno=context.node.lineno,\n+            )\n+    elif func == \"new\":\n+        args = context.call_args\n+        name = args[0] if args else keywords.get(\"name\", None)\n+        if isinstance(name, str) and name.lower() in WEAK_HASHES:\n+            if keywords.get(\"usedforsecurity\", \"True\") == \"True\":\n                 return bandit.Issue(\n-                    severity=bandit.MEDIUM,\n+                    severity=bandit.HIGH,\n                     confidence=bandit.HIGH,\n                     cwe=issue.Cwe.BROKEN_CRYPTO,\n-                    text=f\"Use of insecure {name.upper()} hash function.\",\n+                    text=f\"Use of weak {name.upper()} hash for \"\n+                    \"security. Consider usedforsecurity=False\",\n                     lineno=context.node.lineno,\n                 )\n \n \n+def _hashlib_new(context, func):\n+    if func == \"new\":\n+        args = context.call_args\n+        keywords = context.call_keywords\n+        name = args[0] if args else keywords.get(\"name\", None)\n+        if isinstance(name, str) and name.lower() in WEAK_HASHES:\n+            return bandit.Issue(\n+                severity=bandit.MEDIUM,\n+                confidence=bandit.HIGH,\n+                cwe=issue.Cwe.BROKEN_CRYPTO,\n+                text=f\"Use of insecure {name.upper()} hash function.\",\n+                lineno=context.node.lineno,\n+            )\n+\n+\n+def _crypt_crypt(context, func):\n+    args = context.call_args\n+    keywords = context.call_keywords\n+\n+    if func == \"crypt\":\n+        name = args[1] if len(args) > 1 else keywords.get(\"salt\", None)\n+        if isinstance(name, str) and name in WEAK_CRYPT_HASHES:\n+            return bandit.Issue(\n+                severity=bandit.MEDIUM,\n+                confidence=bandit.HIGH,\n+                cwe=issue.Cwe.BROKEN_CRYPTO,\n+                text=f\"Use of insecure crypt.{name.upper()} hash function.\",\n+                lineno=context.node.lineno,\n+            )\n+    elif func == \"mksalt\":\n+        name = args[0] if args else keywords.get(\"method\", None)\n+        if isinstance(name, str) and name in WEAK_CRYPT_HASHES:\n+            return bandit.Issue(\n+                severity=bandit.MEDIUM,\n+                confidence=bandit.HIGH,\n+                cwe=issue.Cwe.BROKEN_CRYPTO,\n+                text=f\"Use of insecure crypt.{name.upper()} hash function.\",\n+                lineno=context.node.lineno,\n+            )\n+\n+\n @test.test_id(\"B324\")\n @test.checks(\"Call\")\n def hashlib(context):\n-    if sys.version_info >= (3, 9):\n-        return _hashlib_func(context)\n-    else:\n-        return _hashlib_new(context)\n+    if isinstance(context.call_function_name_qual, str):\n+        qualname_list = context.call_function_name_qual.split(\".\")\n+        func = qualname_list[-1]\n+\n+        if \"hashlib\" in qualname_list:\n+            if sys.version_info >= (3, 9):\n+                return _hashlib_func(context, func)\n+            else:\n+                return _hashlib_new(context, func)\n+\n+        elif \"crypt\" in qualname_list and func in (\"crypt\", \"mksalt\"):\n+            return _crypt_crypt(context, func)\ndiff --git a/examples/crypto-md5.py b/examples/crypto-md5.py\nindex b78fd4c82..b827c707d 100644\n--- a/examples/crypto-md5.py\n+++ b/examples/crypto-md5.py\n@@ -8,6 +8,7 @@\n from Cryptodome.Hash import MD5 as pycryptodomex_md5\n from Cryptodome.Hash import SHA as pycryptodomex_sha\n import hashlib\n+import crypt\n \n hashlib.md5(1)\n hashlib.md5(1).hexdigest()\n@@ -32,3 +33,17 @@\n \n hashes.MD5()\n hashes.SHA1()\n+\n+crypt.crypt(\"asdfasdfasdfasdf\", salt=crypt.METHOD_CRYPT)\n+crypt.crypt(\"asdfasdfasdfasdf\", salt=crypt.METHOD_MD5)\n+crypt.crypt(\"asdfasdfasdfasdf\", salt=crypt.METHOD_BLOWFISH)\n+crypt.crypt(\"asdfasdfasdfasdf\")\n+crypt.crypt(\"asdfasdfasdfasdf\", salt=crypt.METHOD_SHA256)\n+crypt.crypt(\"asdfasdfasdfasdf\", salt=crypt.METHOD_SHA512)\n+\n+crypt.mksalt(crypt.METHOD_CRYPT)\n+crypt.mksalt(crypt.METHOD_MD5)\n+crypt.mksalt(crypt.METHOD_BLOWFISH)\n+crypt.mksalt()\n+crypt.mksalt(crypt.METHOD_SHA256)\n+crypt.mksalt(crypt.METHOD_SHA512)\n",
    "repo": "PyCQA/bandit",
    "base_commit": "36fc7be5fdca6cdb2c75b31172e8b0e20e8e1579",
    "hints_text": "",
    "created_at": "2023-04-10T05:31:51Z",
    "test_patch": "diff --git a/tests/functional/test_functional.py b/tests/functional/test_functional.py\nindex bc8689396..9f52e910e 100644\n--- a/tests/functional/test_functional.py\n+++ b/tests/functional/test_functional.py\n@@ -113,14 +113,14 @@ def test_crypto_md5(self):\n                 \"SEVERITY\": {\n                     \"UNDEFINED\": 0,\n                     \"LOW\": 0,\n-                    \"MEDIUM\": 10,\n+                    \"MEDIUM\": 16,\n                     \"HIGH\": 9,\n                 },\n                 \"CONFIDENCE\": {\n                     \"UNDEFINED\": 0,\n                     \"LOW\": 0,\n                     \"MEDIUM\": 0,\n-                    \"HIGH\": 19,\n+                    \"HIGH\": 25,\n                 },\n             }\n         else:\n@@ -128,14 +128,14 @@ def test_crypto_md5(self):\n                 \"SEVERITY\": {\n                     \"UNDEFINED\": 0,\n                     \"LOW\": 0,\n-                    \"MEDIUM\": 16,\n+                    \"MEDIUM\": 22,\n                     \"HIGH\": 4,\n                 },\n                 \"CONFIDENCE\": {\n                     \"UNDEFINED\": 0,\n                     \"LOW\": 0,\n                     \"MEDIUM\": 0,\n-                    \"HIGH\": 20,\n+                    \"HIGH\": 26,\n                 },\n             }\n         self.check_example(\"crypto-md5.py\", expect)\n",
    "problem_statement": "Use of crypt should be flagged\n### Describe the bug\n\nThe crypt module of base Python is already deprecated as of 3.11, but it is still functional\r\nusable to create weak hashes. \r\n\r\nhttps://docs.python.org/3.11/library/crypt.html#module-crypt\n\n### Reproduction steps\n\n```bash\nFor example, someone may still utilize this module to generate MD5 hashes like so.\r\n\r\n\r\ncrypt.crypt(\"sadfasdfasdfsdaf\", salt=crypt.METHOD_MD5)\r\n```\n```\n\n\n### Expected behavior\n\nI'd expect Bandit to issue warnings about using this module.\r\n\r\nProbably all the following methods should be warnings:\r\n\r\ncrypt.METHOD_BLOWFISH\r\ncrypt.METHOD_MD5\r\ncrypt.METHOD_CRYPT\n\n### Bandit version\n\n1.7.5 (Default)\n\n### Python version\n\n3.7\n\n### Additional context\n\n_No response_\n",
    "environment_setup_commit": "36fc7be5fdca6cdb2c75b31172e8b0e20e8e1579",
    "pr_url": "https://github.com/PyCQA/bandit/pull/1018",
    "issue_url": "https://github.com/PyCQA/bandit/issues/1017",
    "issue_numbers": [
        "1017"
    ]
}