{
    "instance_id": "getpelican__pelican-3215",
    "patch": "diff --git a/pelican/tools/pelican_import.py b/pelican/tools/pelican_import.py\nindex cd643ec62..474b5cba0 100755\n--- a/pelican/tools/pelican_import.py\n+++ b/pelican/tools/pelican_import.py\n@@ -390,22 +390,22 @@ def dc2fields(file):\n                post_format)\n \n \n-def tumblr2fields(api_key, blogname):\n-    \"\"\" Imports Tumblr posts (API v2)\"\"\"\n+def _get_tumblr_posts(api_key, blogname, offset=0):\n     import json\n     import urllib.request as urllib_request\n+    url = (\"https://api.tumblr.com/v2/blog/%s.tumblr.com/\"\n+           \"posts?api_key=%s&offset=%d&filter=raw\") % (\n+        blogname, api_key, offset)\n+    request = urllib_request.Request(url)\n+    handle = urllib_request.urlopen(request)\n+    posts = json.loads(handle.read().decode('utf-8'))\n+    return posts.get('response').get('posts')\n \n-    def get_tumblr_posts(api_key, blogname, offset=0):\n-        url = (\"https://api.tumblr.com/v2/blog/%s.tumblr.com/\"\n-               \"posts?api_key=%s&offset=%d&filter=raw\") % (\n-            blogname, api_key, offset)\n-        request = urllib_request.Request(url)\n-        handle = urllib_request.urlopen(request)\n-        posts = json.loads(handle.read().decode('utf-8'))\n-        return posts.get('response').get('posts')\n \n+def tumblr2fields(api_key, blogname):\n+    \"\"\" Imports Tumblr posts (API v2)\"\"\"\n     offset = 0\n-    posts = get_tumblr_posts(api_key, blogname, offset)\n+    posts = _get_tumblr_posts(api_key, blogname, offset)\n     subs = DEFAULT_CONFIG['SLUG_REGEX_SUBSTITUTIONS']\n     while len(posts) > 0:\n         for post in posts:\n@@ -428,12 +428,10 @@ def get_tumblr_posts(api_key, blogname, offset=0):\n                     fmtstr = '![%s](%s)'\n                 else:\n                     fmtstr = '<img alt=\"%s\" src=\"%s\" />'\n-                content = ''\n-                for photo in post.get('photos'):\n-                    content += '\\n'.join(\n-                        fmtstr % (photo.get('caption'),\n-                                  photo.get('original_size').get('url')))\n-                content += '\\n\\n' + post.get('caption')\n+                content = '\\n'.join(\n+                    fmtstr % (photo.get('caption'),\n+                              photo.get('original_size').get('url'))\n+                    for photo in post.get('photos'))\n             elif type == 'quote':\n                 if format == 'markdown':\n                     fmtstr = '\\n\\n&mdash; %s'\n@@ -483,7 +481,7 @@ def get_tumblr_posts(api_key, blogname, offset=0):\n                    tags, status, kind, format)\n \n         offset += len(posts)\n-        posts = get_tumblr_posts(api_key, blogname, offset)\n+        posts = _get_tumblr_posts(api_key, blogname, offset)\n \n \n def feed2fields(file):\n",
    "repo": "getpelican/pelican",
    "base_commit": "fab6e1a2c51317b1ff3523755cd82f7b3ea3d433",
    "hints_text": "",
    "created_at": "2023-10-25T23:38:55Z",
    "test_patch": "diff --git a/pelican/tests/test_importer.py b/pelican/tests/test_importer.py\nindex 743cea8c6..3855e3828 100644\n--- a/pelican/tests/test_importer.py\n+++ b/pelican/tests/test_importer.py\n@@ -1,7 +1,11 @@\n+import datetime\n import locale\n import os\n import re\n from posixpath import join as posix_join\n+from unittest.mock import patch\n+\n+import dateutil.tz\n \n from pelican.settings import DEFAULT_CONFIG\n from pelican.tests.support import (mute, skipIfNoExecutable, temporary_folder,\n@@ -10,9 +14,12 @@\n                                           build_markdown_header,\n                                           decode_wp_content,\n                                           download_attachments, fields2pelican,\n-                                          get_attachments, wp2fields)\n+                                          get_attachments, tumblr2fields,\n+                                          wp2fields,\n+                                          )\n from pelican.utils import path_to_file_url, slugify\n \n+\n CUR_DIR = os.path.abspath(os.path.dirname(__file__))\n BLOGGER_XML_SAMPLE = os.path.join(CUR_DIR, 'content', 'bloggerexport.xml')\n WORDPRESS_XML_SAMPLE = os.path.join(CUR_DIR, 'content', 'wordpressexport.xml')\n@@ -34,17 +41,26 @@\n     LXML = False\n \n \n-@skipIfNoExecutable(['pandoc', '--version'])\n-@unittest.skipUnless(BeautifulSoup, 'Needs BeautifulSoup module')\n-class TestBloggerXmlImporter(unittest.TestCase):\n-\n+class TestWithOsDefaults(unittest.TestCase):\n+    \"\"\"Set locale to C and timezone to UTC for tests, then restore.\"\"\"\n     def setUp(self):\n         self.old_locale = locale.setlocale(locale.LC_ALL)\n         locale.setlocale(locale.LC_ALL, 'C')\n-        self.posts = blogger2fields(BLOGGER_XML_SAMPLE)\n+        self.old_timezone = datetime.datetime.now(dateutil.tz.tzlocal()).tzname()\n+        os.environ['TZ'] = 'UTC'\n \n     def tearDown(self):\n         locale.setlocale(locale.LC_ALL, self.old_locale)\n+        os.environ['TZ'] = self.old_timezone\n+\n+\n+@skipIfNoExecutable(['pandoc', '--version'])\n+@unittest.skipUnless(BeautifulSoup, 'Needs BeautifulSoup module')\n+class TestBloggerXmlImporter(TestWithOsDefaults):\n+\n+    def setUp(self):\n+        super().setUp()\n+        self.posts = blogger2fields(BLOGGER_XML_SAMPLE)\n \n     def test_recognise_kind_and_title(self):\n         \"\"\"Check that importer only outputs pages, articles and comments,\n@@ -85,17 +101,13 @@ def test_recognise_status_with_correct_filename(self):\n \n @skipIfNoExecutable(['pandoc', '--version'])\n @unittest.skipUnless(BeautifulSoup, 'Needs BeautifulSoup module')\n-class TestWordpressXmlImporter(unittest.TestCase):\n+class TestWordpressXmlImporter(TestWithOsDefaults):\n \n     def setUp(self):\n-        self.old_locale = locale.setlocale(locale.LC_ALL)\n-        locale.setlocale(locale.LC_ALL, 'C')\n+        super().setUp()\n         self.posts = wp2fields(WORDPRESS_XML_SAMPLE)\n         self.custposts = wp2fields(WORDPRESS_XML_SAMPLE, True)\n \n-    def tearDown(self):\n-        locale.setlocale(locale.LC_ALL, self.old_locale)\n-\n     def test_ignore_empty_posts(self):\n         self.assertTrue(self.posts)\n         for (title, content, fname, date, author,\n@@ -477,3 +489,46 @@ def test_download_attachments(self):\n             self.assertTrue(\n                 directory.endswith(posix_join('content', 'article.rst')),\n                 directory)\n+\n+\n+class TestTumblrImporter(TestWithOsDefaults):\n+    @patch(\"pelican.tools.pelican_import._get_tumblr_posts\")\n+    def test_posts(self, get):\n+        def get_posts(api_key, blogname, offset=0):\n+            if offset > 0:\n+                return []\n+\n+            return [\n+                {\n+                    \"type\": \"photo\",\n+                    \"blog_name\": \"testy\",\n+                    \"date\": \"2019-11-07 21:26:40 GMT\",\n+                    \"timestamp\": 1573162000,\n+                    \"format\": \"html\",\n+                    \"slug\": \"a-slug\",\n+                    \"tags\": [\n+                        \"economics\"\n+                    ],\n+                    \"state\": \"published\",\n+\n+                    \"photos\": [\n+                        {\n+                            \"caption\": \"\",\n+                            \"original_size\": {\n+                                \"url\": \"https://..fccdc2360ba7182a.jpg\",\n+                                \"width\": 634,\n+                                \"height\": 789\n+                            },\n+                        }]\n+                }\n+            ]\n+        get.side_effect = get_posts\n+\n+        posts = list(tumblr2fields(\"api_key\", \"blogname\"))\n+        self.assertEqual(\n+            [('Photo',\n+              '<img alt=\"\" src=\"https://..fccdc2360ba7182a.jpg\" />\\n',\n+              '2019-11-07-a-slug', '2019-11-07 21:26:40', 'testy', ['photo'],\n+              ['economics'], 'published', 'article', 'html')],\n+            posts,\n+            posts)\n",
    "problem_statement": "Import yields incorrect link for Tumblr image posts\n<!--\r\n  Hi there! Thank you for discovering and submitting an issue.\r\n\r\n  Before you submit this, let‚Äôs make sure of a few things.\r\n  Please make sure the following boxes are ticked if they are correct.\r\n  If not, please try and fulfill them first.\r\n-->\r\n\r\n<!-- Checked checkbox should look like this: [x] -->\r\n- [x] I have read the [Filing Issues](https://docs.getpelican.com/en/latest/contribute.html#filing-issues) and subsequent ‚ÄúHow to Get Help‚Äù sections of the documentation.\r\n- [x] I have searched the [issues](https://github.com/getpelican/pelican/issues?q=is%3Aissue) (including closed ones) and believe that this is not a duplicate.\r\n\r\n<!--\r\n  Once the above boxes are checked, if you are able to fill in the following list\r\n  with your information, it would be very helpful for maintainers.\r\n-->\r\n\r\n- **OS version and name**: OS X 12.6.7\r\n- **Python version**: 3.11.4\r\n- **Pelican version**: 4.8.0\r\n- **Link to theme**: default\r\n- **Links to plugins**: default\r\n- **Link to your site**: n/a\r\n- **Link to your source**: n/a\r\n- **Link to a [Gist](https://gist.github.com/) with the contents of your settings file**: n/a\r\n\r\n## Issue\r\n<!--\r\n  Now feel free to write your issue. Please avoid vague phrases like ‚Äú[‚Ä¶] doesn‚Äôt work‚Äù.\r\n  Be descriptive! Thanks again üôå ‚ù§Ô∏è\r\n-->\r\n\r\nImporting tumblr blog entry with an image produces an incorrect link.\r\n\r\nFor example, https://www.tumblr.com/boxydog/188887119699/a-nice-visualization-of-whats-been-getting produces the link all spread out one letter at a time (see below). I bet the python code is iterating over a string when it thinks it's iterating over a list.\r\n\r\nFirst 50 lines of the .rst file:\r\n\r\n```\r\n$ head -50 boxydog.com/2019-11-07-a-nice-visualization-of-whats-been-getting.rst \r\nblog.bluecrossmn.com\r\n####################\r\n:date: 2019-11-07 15:26:40\r\n:author: boxydog\r\n:category: photo\r\n:tags: economics\r\n:slug: 2019-11-07-a-nice-visualization-of-whats-been-getting\r\n:status: published\r\n\r\n<\r\n\r\ni\r\n\r\nm\r\n\r\ng\r\n\r\na\r\n\r\nl\r\n\r\nt\r\n\r\n=\r\n\r\n\"\r\n\r\n\"\r\n\r\ns\r\n\r\nr\r\n\r\nc\r\n\r\n=\r\n\r\n\"\r\n\r\nh\r\n\r\nt\r\n\r\nt\r\n\r\np\r\n\r\ns\r\n\r\n:\r\n```\n",
    "environment_setup_commit": "fab6e1a2c51317b1ff3523755cd82f7b3ea3d433",
    "pr_url": "https://github.com/getpelican/pelican/pull/3215",
    "issue_url": "https://github.com/getpelican/pelican/issues/3178",
    "issue_numbers": [
        "3178"
    ]
}