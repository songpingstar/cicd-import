{
    "instance_id": "marimo-team__marimo-6887",
    "patch": "diff --git a/marimo/_plugins/ui/_impl/altair_chart.py b/marimo/_plugins/ui/_impl/altair_chart.py\nindex 87c3c272e99..347f6e40b2b 100644\n--- a/marimo/_plugins/ui/_impl/altair_chart.py\n+++ b/marimo/_plugins/ui/_impl/altair_chart.py\n@@ -612,6 +612,13 @@ def maybe_make_full_width(chart: AltairChartType) -> AltairChartType:\n             isinstance(chart, (alt.Chart, alt.LayerChart))\n             and chart.width is alt.Undefined\n         ):\n+            # Don't make full width if chart has column encoding (faceted)\n+            if (\n+                hasattr(chart, \"encoding\")\n+                and hasattr(chart.encoding, \"column\")\n+                and chart.encoding.column is not alt.Undefined\n+            ):\n+                return chart\n             return chart.properties(width=\"container\")\n         return chart\n     except Exception:\n",
    "repo": "marimo-team/marimo",
    "base_commit": "12b174df72d8731ee62f6c90d108711db5719ebf",
    "hints_text": "we change the defaults for `.properties(width=` to work well in _most_ cases. but you can unset this if you'd like. `width=300` is the original default. \n\n```\n    alt.Chart(source).mark_bar().encode(\n        x=\"year:O\",\n        y=\"sum(yield):Q\",\n        color=\"year:N\",\n        column=\"site:N\",\n    ).properties(width=300)\n```\n\nLet us know if you have any issues. Happy to keep the discussion going\nMy apologies, I should have mentioned that I'd already tried to manually set the width to no effect. I tried wrapping the chart with `mo.ui.altair_chart` as well, also to no effect. Other data sources exhibit the same behavior.\n@fran-penedo. this does work for me, but i think we can do something additional to avoid setting the width full when `column` is set\n\n```\nimport altair as alt\nfrom vega_datasets import data\n\nsource = data.barley()\nc = alt.Chart(source).mark_bar().encode(\n    x=\"year:O\",\n    y=\"sum(yield):Q\",\n    color=\"year:N\",\n    column=\"site:N\",\n).properties(width=100, height=200)\n```\n",
    "created_at": "2025-10-22T19:01:44Z",
    "test_patch": "diff --git a/marimo/_smoke_tests/altair_examples/column_facet.py b/marimo/_smoke_tests/altair_examples/column_facet.py\nnew file mode 100644\nindex 00000000000..cdc8f5f64d4\n--- /dev/null\n+++ b/marimo/_smoke_tests/altair_examples/column_facet.py\n@@ -0,0 +1,52 @@\n+import marimo\n+\n+__generated_with = \"0.17.0\"\n+app = marimo.App(width=\"medium\")\n+\n+\n+@app.cell\n+def _():\n+    import marimo as mo\n+    return (mo,)\n+\n+\n+@app.cell\n+def _():\n+    import altair as alt\n+    from vega_datasets import data\n+\n+    source = data.barley()\n+    chart = (\n+        alt.Chart(source)\n+        .mark_bar()\n+        .encode(\n+            x=\"year:O\",\n+            y=\"sum(yield):Q\",\n+            color=\"year:N\",\n+            column=\"site:N\",\n+        )\n+    )\n+    chart\n+    return (chart,)\n+\n+\n+@app.cell\n+def _(chart, mo):\n+    mo.ui.altair_chart(chart)\n+    return\n+\n+\n+@app.cell\n+def _(chart):\n+    chart.encoding.column\n+    return\n+\n+\n+@app.cell\n+def _(chart):\n+    type(chart).mro()\n+    return\n+\n+\n+if __name__ == \"__main__\":\n+    app.run()\ndiff --git a/tests/_plugins/ui/_impl/test_altair_chart.py b/tests/_plugins/ui/_impl/test_altair_chart.py\nindex 855c67cf76c..e20759426a5 100644\n--- a/tests/_plugins/ui/_impl/test_altair_chart.py\n+++ b/tests/_plugins/ui/_impl/test_altair_chart.py\n@@ -1069,3 +1069,35 @@ def test_update_vconcat_width() -> None:\n     updated_hconcat = _update_vconcat_width(hconcat_chart)\n     assert updated_hconcat.hconcat[0].width == \"container\"\n     assert updated_hconcat.hconcat[1].width == \"container\"\n+\n+\n+@pytest.mark.skipif(not HAS_DEPS, reason=\"optional dependencies not installed\")\n+def test_chart_with_column_encoding_not_full_width() -> None:\n+    import altair as alt\n+\n+    from marimo._plugins.ui._impl.altair_chart import maybe_make_full_width\n+\n+    # Create a chart with column encoding (faceted chart)\n+    data = pd.DataFrame(\n+        {\n+            \"x\": [1, 2, 3, 4],\n+            \"y\": [4, 5, 6, 7],\n+            \"category\": [\"A\", \"B\", \"A\", \"B\"],\n+        }\n+    )\n+    chart = (\n+        alt.Chart(data)\n+        .mark_point()\n+        .encode(x=\"x:Q\", y=\"y:Q\", column=\"category:N\")\n+    )\n+\n+    # Test that chart with column encoding is NOT made full width\n+    result = maybe_make_full_width(chart)\n+    assert result.width is alt.Undefined\n+\n+    # Test that chart without column encoding IS made full width\n+    chart_without_column = (\n+        alt.Chart(data).mark_point().encode(x=\"x:Q\", y=\"y:Q\")\n+    )\n+    result_without_column = maybe_make_full_width(chart_without_column)\n+    assert result_without_column.width == \"container\"\n",
    "problem_statement": "Altair grouped bar chart has incorrect size\n### Describe the bug\n\nWhen I try to plot an Altair bar chart using the `column` property in the encoding, marimo displays a chart where each column seems to be the full size of the container:\n\n<img width=\"1020\" height=\"653\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/559d42a3-7355-4a84-ac86-256b98f959f2\" />\n\nThe example code was extracted from the Altair documentation: https://altair-viz.github.io/gallery/grouped_bar_chart.html.\n\n### Will you submit a PR?\n\n- [ ] Yes\n\n### Environment\n\n<details>\n\n```\n{\n  \"marimo\": \"0.17.0\",\n  \"editable\": false,\n  \"location\": \"/home/fran/.cache/uv/archive-v0/C3j96rMYcRABj32SQWhtN/lib/python3.13/site-packages/marimo\",\n  \"OS\": \"Linux\",\n  \"OS Version\": \"6.17.2-arch1-1\",\n  \"Processor\": \"\",\n  \"Python Version\": \"3.13.7\",\n  \"Locale\": \"en_US\",\n  \"Binaries\": {\n    \"Browser\": \"--\",\n    \"Node\": \"v22.19.0\"\n  },\n  \"Dependencies\": {\n    \"click\": \"8.2.1\",\n    \"docutils\": \"0.21.2\",\n    \"itsdangerous\": \"2.2.0\",\n    \"jedi\": \"0.19.2\",\n    \"markdown\": \"3.9\",\n    \"narwhals\": \"2.9.0\",\n    \"packaging\": \"25.0\",\n    \"psutil\": \"7.1.0\",\n    \"pygments\": \"2.19.2\",\n    \"pymdown-extensions\": \"10.16.1\",\n    \"pyyaml\": \"6.0.3\",\n    \"starlette\": \"0.48.0\",\n    \"tomlkit\": \"0.13.3\",\n    \"typing-extensions\": \"4.15.0\",\n    \"uvicorn\": \"0.38.0\",\n    \"websockets\": \"15.0.1\"\n  },\n  \"Optional Dependencies\": {\n    \"altair\": \"5.5.0\",\n    \"duckdb\": \"1.4.1\",\n    \"nbformat\": \"5.10.4\",\n    \"openai\": \"2.6.0\",\n    \"pandas\": \"2.3.3\",\n    \"polars\": \"1.34.0\",\n    \"pyarrow\": \"21.0.0\",\n    \"loro\": \"1.8.1\",\n    \"pytest\": \"8.4.2\",\n    \"ruff\": \"0.14.1\",\n    \"sqlglot\": \"27.28.1\"\n  },\n  \"Experimental Flags\": {}\n}\n```\n\n</details>\n\n\n### Code to reproduce\n\n```python\n# /// script\n# requires-python = \">=3.13\"\n# dependencies = [\n#     \"altair==5.5.0\",\n#     \"marimo\",\n#     \"vega-datasets==0.9.0\",\n# ]\n# ///\n\nimport marimo\n\n__generated_with = \"0.17.0\"\napp = marimo.App(width=\"medium\")\n\n\n@app.cell\ndef _():\n    import altair as alt\n    from vega_datasets import data\n\n    source = data.barley()\n    alt.Chart(source).mark_bar().encode(\n        x=\"year:O\",\n        y=\"sum(yield):Q\",\n        color=\"year:N\",\n        column=\"site:N\",\n    )\n    return\n\n\nif __name__ == \"__main__\":\n    app.run()\n```\n",
    "environment_setup_commit": "12b174df72d8731ee62f6c90d108711db5719ebf",
    "pr_url": "https://github.com/marimo-team/marimo/pull/6887",
    "issue_url": "https://github.com/marimo-team/marimo/issues/6865",
    "issue_numbers": [
        "6865"
    ]
}