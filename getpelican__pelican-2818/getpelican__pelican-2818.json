{
    "instance_id": "getpelican__pelican-2818",
    "patch": "diff --git a/pelican/plugins/_utils.py b/pelican/plugins/_utils.py\nindex 4e6ec3c5d..ffe32799b 100644\n--- a/pelican/plugins/_utils.py\n+++ b/pelican/plugins/_utils.py\n@@ -53,6 +53,9 @@ def load_legacy_plugin(plugin, plugin_paths):\n     if spec is None:\n         raise ImportError('Cannot import plugin `{}`'.format(plugin))\n     else:\n+        # Avoid loading the same plugin twice\n+        if spec.name in sys.modules:\n+            return sys.modules[spec.name]\n         # create module object from spec\n         mod = importlib.util.module_from_spec(spec)\n         # place it into sys.modules cache\n",
    "repo": "getpelican/pelican",
    "base_commit": "e4d9c41a77b45cb7ff6b8d1732623990adf65931",
    "hints_text": "Thanks. I would expect old module to be deleted/garbage collected since it is overridden in the `sys.modules`. Returning module if it is already present makes sense, but `try/except` is a bit unnecessary. A simple `if` would do:\r\n\r\n```python\r\nif spec.name in sys.modules:\r\n    return sys.modules[spec.name]\r\n```\n> Thanks. I would expect old module to be deleted/garbage collected since it is overridden in the `sys.modules`. Returning module if it is already present makes sense, but `try/except` is a bit unnecessary. A simple `if` would do:\r\n> \r\n> ```python\r\n> if spec.name in sys.modules:\r\n>     return sys.modules[spec.name]\r\n> ```\r\n\r\nI used `try/except` to make it consistent with: https://github.com/getpelican/pelican/blob/e4d9c41a77b45cb7ff6b8d1732623990adf65931/pelican/plugins/_utils.py#L65-L69\r\n\r\nI will use `if` instead in my commit.",
    "created_at": "2020-10-31T12:45:43Z",
    "test_patch": "diff --git a/pelican/tests/test_plugins.py b/pelican/tests/test_plugins.py\nindex 06940884c..29729539e 100644\n--- a/pelican/tests/test_plugins.py\n+++ b/pelican/tests/test_plugins.py\n@@ -131,6 +131,17 @@ def get_plugin_names(plugins):\n                  'normal subpackage plugin'},\n                 get_plugin_names(plugins))\n \n+            # ensure normal plugins are loaded only once\n+            SETTINGS = {\n+                'PLUGINS': ['normal_plugin'],\n+                'PLUGIN_PATHS': [self._NORMAL_PLUGIN_FOLDER],\n+            }\n+            plugins = load_plugins(SETTINGS)\n+            for plugin in load_plugins(SETTINGS):\n+                # The second load_plugins() should return the same plugin\n+                # objects as the first one\n+                self.assertIn(plugin, plugins)\n+\n             # namespace plugin short\n             SETTINGS = {\n                 'PLUGINS': ['ns_plugin']\n",
    "problem_statement": "Plugins run twice in autoreload mode\n<!--\r\n  Hi there! Thank you for discovering and submitting an issue.\r\n\r\n  Before you submit this, let’s make sure of a few things.\r\n  Please make sure the following boxes are ticked if they are correct.\r\n  If not, please try and fulfill them first.\r\n-->\r\n\r\n<!-- Checked checkbox should look like this: [x] -->\r\n- [x] I have read the [Filing Issues](https://docs.getpelican.com/en/latest/contribute.html#filing-issues) and subsequent “How to Get Help” sections of the documentation.\r\n- [x] I have searched the [issues](https://github.com/getpelican/pelican/issues?q=is%3Aissue) (including closed ones) and believe that this is not a duplicate.\r\n\r\n<!--\r\n  Once the above boxes are checked, if you are able to fill in the following list\r\n  with your information, it would be very helpful for maintainers.\r\n-->\r\n\r\n- **OS version and name**: Ubuntu 18.04.5 LTS (WSL)\r\n- **Python version**: 3.8.6\r\n- **Pelican version**: e4d9c41a\r\n\r\n## To reproduce\r\n\r\nCreate these files:\r\n\r\n```\r\n.\r\n├── content\r\n│   └── 1.rst\r\n├── pelicanconf.py\r\n└── plugins\r\n    └── test_plugin.py\r\n```\r\n\r\n```rst\r\n.. content/1.rst\r\n####\r\ntest\r\n####\r\n\r\n:date: 1970-01-01\r\n:modified: 1970-01-01\r\n\r\nTEST\r\n```\r\n\r\n```python\r\n# pelicanconf.py\r\nPLUGINS = [\r\n    'test_plugin',\r\n]\r\nPLUGIN_PATHS = [\r\n    'plugins',\r\n]\r\n```\r\n\r\n```python\r\n# plugins/test_plugin.py\r\nimport logging\r\n\r\nfrom pelican import signals\r\n\r\nlogger = logging.getLogger(__name__)\r\n\r\n\r\ndef test_function(content):\r\n    logger.info('test plugin loaded')\r\n    test = content._content\r\n    test += 'TEST'\r\n    content._content = test\r\n    logger.info(content._content)\r\n\r\n\r\ndef register():\r\n    signals.content_object_init.connect(test_function)\r\n```\r\n\r\nThen run:\r\n\r\n```console\r\n$ pelican -rD --logs-dedup-min-level DEBUG content\r\n[Not showing unrelated logs]\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TEST\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TESTTEST\r\n\r\n$ pelican -D --logs-dedup-min-level DEBUG content\r\n[Not showing unrelated logs]\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TEST\r\n```\r\n\r\nThe plugin runs twice with `-r`, but only once without `-r`.\r\n\r\n## The casue of the issue\r\n\r\nAfter a bisect, I found that commit ed1eca16 introduced this issue.\r\n\r\n```console\r\n$ git checkout ed1eca16^\r\n$ pelican -rD --logs-dedup-min-level DEBUG content\r\n[Not showing unrelated logs]\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TEST\r\n\r\n$ git checkout ed1eca16\r\n$ pelican -rD --logs-dedup-min-level DEBUG content\r\n[Not showing unrelated logs]\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TEST\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TESTTEST\r\n```\r\n\r\nAfter adding this line, I found that the plugin was registered twice:\r\n\r\n```diff\r\ndiff --git a/pelican/contents.py b/pelican/contents.py\r\nindex 594cd3b5..ff991be9 100644\r\n--- a/pelican/contents.py\r\n+++ b/pelican/contents.py\r\n@@ -139,6 +139,7 @@ class Content(object):\r\n         if 'summary' in metadata:\r\n             self._summary = metadata['summary']\r\n\r\n+        logger.info(str(signals.content_object_init.receivers))\r\n         signals.content_object_init.send(self)\r\n\r\n     def __str__(self):\r\n```\r\n\r\n```console\r\n$ pelican -rD --logs-dedup-min-level DEBUG content\r\n[Not showing unrelated logs]\r\n-> {140542259499216: <weakref at 0x7fd28a2b8b80; to 'function' at 0x7fd28b7410d0 (test_function)>, 140542259600400: <weakref at 0x7fd28b7525e0; to 'function' at 0x7fd28b759c10 (test_function)>}\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TEST\r\n-> test plugin loaded\r\n-> <p>TEST</p>\r\n  | TESTTEST\r\n```\r\n\r\nBut why? The reason:\r\n\r\n```python\r\n>>> # Implementation of ed1eca16^\r\n>>> import sys\r\n>>> sys.path.insert(0, 'plugins')\r\n>>> plugin = __import__('test_plugin', globals(), locals(), str('module'))\r\n>>> plugin_ = __import__('test_plugin', globals(), locals(), str('module'))\r\n>>> plugin is plugin_\r\nTrue\r\n>>>\r\n>>> # Implementation of ed1eca16\r\n>>> import importlib\r\n>>> spec = importlib.machinery.PathFinder.find_spec('test_plugin', ['plugins'])\r\n>>> plugin = importlib.util.module_from_spec(spec)\r\n>>> plugin_ = importlib.util.module_from_spec(spec)\r\n>>> plugin is plugin_\r\nFalse\r\n```\r\n\r\n## How to fix\r\n\r\nTo fix it, simply avoid loading the same plugin twice:\r\n\r\n```diff\r\ndiff --git a/pelican/plugins/_utils.py b/pelican/plugins/_utils.py\r\nindex 4e6ec3c5..699192d3 100644\r\n--- a/pelican/plugins/_utils.py\r\n+++ b/pelican/plugins/_utils.py\r\n@@ -53,6 +53,11 @@ def load_legacy_plugin(plugin, plugin_paths):\r\n     if spec is None:\r\n         raise ImportError('Cannot import plugin `{}`'.format(plugin))\r\n     else:\r\n+        # Avoid loading the same plugin twice\r\n+        try:\r\n+            return sys.modules[spec.name]\r\n+        except KeyError:\r\n+            pass\r\n         # create module object from spec\r\n         mod = importlib.util.module_from_spec(spec)\r\n         # place it into sys.modules cache\r\n```\r\n\r\nI will create a pull request after writing some tests for it.\r\n\r\n\n",
    "environment_setup_commit": "e4d9c41a77b45cb7ff6b8d1732623990adf65931",
    "pr_url": "https://github.com/getpelican/pelican/pull/2818",
    "issue_url": "https://github.com/getpelican/pelican/issues/2817",
    "issue_numbers": [
        "2817"
    ]
}